name: Deploy Multi-Services to GitHub Pages

on:
  # åœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [main]
    paths:
      - "docs/**"
      - "packages/**"
      - "apps/**/README.md"
      - "apps/**/src/**/*.stories.*"
      - "README.md"

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½® GITHUB_TOKEN æƒé™ä»¥å…è®¸éƒ¨ç½²åˆ° GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²ï¼Œè·³è¿‡æ­£åœ¨è¿è¡Œçš„éƒ¨ç½²å’Œæœ€æ–°çš„æ’é˜Ÿéƒ¨ç½²
concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build workspace packages
        run: |
          # Build utils package first (required for API)
          echo "ğŸ”¨ Building @sylis/utils package..."
          pnpm --filter "@sylis/utils" run build

          # Verify utils build output - tsup generates index.js (CJS) and index.mjs (ESM)
          echo "ğŸ” Verifying build output..."
          ls -la packages/utils/dist/

          if [ ! -f "packages/utils/dist/index.js" ]; then
            echo "âŒ Error: index.js (CommonJS) not found"
            exit 1
          fi

          if [ ! -f "packages/utils/dist/index.mjs" ]; then
            echo "âŒ Error: index.mjs (ESM) not found"
            exit 1
          fi

          echo "âœ… @sylis/utils build successful - all required files generated"

          # Build shared package if needed (no build script, but check if exports exist)
          echo "ğŸ“¦ Checking @sylis/shared package..."
          ls -la packages/shared/dto/ || echo "Shared package structure check"

      - name: Generate Prisma client
        run: pnpm --filter "./apps/api" run prisma:generate

      - name: Build API and generate Swagger docs
        env:
          NODE_ENV: production
          DATABASE_URL: "postgresql://user:pass@localhost:5432/db"
          REDIS_URL: "redis://localhost:6379"
        run: |
          # Verify workspace dependencies are available
          echo "Checking workspace dependencies..."
          ls -la packages/utils/dist/ || echo "Utils dist not found"

          # Build API
          cd apps/api
          pnpm run build
          pnpm run swagger:generate || echo "Swagger generation failed, continuing without it"

      - name: Build Documentation (Overview)
        run: |
          cd docs/overview
          NODE_ENV=production pnpm run docs:build

      - name: Build Storybook
        run: |
          cd docs/components
          NODE_ENV=production pnpm run build

      - name: Combine services
        run: |
          # åˆ›å»ºæœ€ç»ˆéƒ¨ç½²ç›®å½•
          mkdir -p final-dist

          # å¤åˆ¶ Overview æ–‡æ¡£åˆ°æ ¹ç›®å½• (ä½œä¸ºä¸»å…¥å£)
          cp -r docs/overview/.vitepress/dist/* final-dist/

          # å¤åˆ¶ç»„ä»¶åº“åˆ° components å­ç›®å½•
          mkdir -p final-dist/components
          cp -r docs/components/dist/* final-dist/components/

          # å¤åˆ¶ Swagger æ–‡æ¡£åˆ° swagger å­ç›®å½• (å¦‚æœå­˜åœ¨)
          if [ -d "apps/api/dist/swagger" ]; then
            mkdir -p final-dist/swagger
            cp -r apps/api/dist/swagger/* final-dist/swagger/
            echo "Swagger documentation included"
          else
            echo "Swagger documentation not found, skipping"
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: final-dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    needs: build
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
